name: Create release from tag

on:
  push:
    tags: ['*']

permissions:
  contents: write
  packages: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: prerelease
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ _rc[0-9]+$ ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi
      - run: |
          cat > body.md <<HERE
          <img align="right" width="180" height="360" src="https://github.com/samcday/phrog/releases/download/${GITHUB_REF_NAME}/demo.webp">
          HERE
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: body.md
          generate_release_notes: true
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          draft: true
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}

  build:
    needs: release
    uses: ./.github/workflows/build.yml
    secrets: inherit

  alpine:
    needs: release
    uses: ./.github/workflows/alpine.yml
    with:
      release_mode: true
    secrets: inherit

  release-builds:
    needs: release
    uses: ./.github/workflows/release-builds.yml
    secrets: inherit

  publish-assets:
    needs: [build, alpine, release-builds]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: demo-video
          path: demo-video/
      - uses: actions/download-artifact@v4
        with:
          name: APKBUILD
          path: packages/
      - uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: packages/
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist/
          merge-multiple: true
      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          files: |
            demo-video/demo.mp4
            demo-video/demo.webp
            packages/APKBUILD
            packages/*.apk
            dist/*.tar.gz

  publish-crate:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4
      - name: Publish phrog to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          cargo publish --locked --no-verify

  pass:
    name: âœ… Pass
    needs: [build, alpine, release-builds, publish-assets, publish-crate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  publish-release:
    needs: [pass]
    if: needs.pass.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Publish draft release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          release_id="$(gh api "repos/${GITHUB_REPOSITORY}/releases/tags/${GITHUB_REF_NAME}" --jq .id)"
          gh api -X PATCH "repos/${GITHUB_REPOSITORY}/releases/${release_id}" -f draft=false >/dev/null
